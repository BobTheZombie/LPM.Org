#!/usr/bin/env python3
from __future__ import annotations

import os
import shlex
import shutil
import subprocess
import sys
from pathlib import Path
from typing import Iterable, List

from _targets import collect_targets


def _log(message: str) -> None:
    print(f"[lpm:kernel-install] {message}", flush=True)


def _format_command(args: Iterable[str]) -> str:
    return " ".join(shlex.quote(str(part)) for part in args)


def _run_command(args: List[str], *, check: bool = True) -> subprocess.CompletedProcess:
    _log(f"Running: {_format_command(args)}")
    return subprocess.run(args, check=check)


def _extract_module_version(target: str) -> str | None:
    path = Path(target)
    if not path.is_absolute():
        path = Path("/") / path
    parts = path.parts
    try:
        idx = parts.index("modules")
    except ValueError:
        return None
    if idx + 1 >= len(parts):
        return None
    version = parts[idx + 1]
    return version or None


def _collect_versions(argv: Iterable[str]) -> List[str]:
    versions: List[str] = []
    for target in collect_targets(argv):
        version = _extract_module_version(target)
        if version:
            versions.append(version)
    env_version = os.environ.get("LPM_VERSION", "").strip()
    if env_version:
        versions.append(env_version)
    seen = set()
    ordered: List[str] = []
    for value in versions:
        if value not in seen:
            seen.add(value)
            ordered.append(value)
    return ordered


def _run_mkinitcpio(root: Path, version: str) -> None:
    output = root / "boot" / f"initrd-{version}.img"
    output.parent.mkdir(parents=True, exist_ok=True)
    args = ["mkinitcpio"]
    if root != Path("/"):
        args.extend(["-r", str(root)])
    args.extend(["-k", version, "-g", str(output)])
    _run_command(args)


def _run_depmod(root: Path, version: str) -> None:
    args = ["depmod"]
    if root != Path("/"):
        args.extend(["-b", str(root)])
    args.append(version)
    _run_command(args)


def _run_preset(root: Path, preset: str) -> None:
    args = ["mkinitcpio"]
    if root != Path("/"):
        args.extend(["-r", str(root)])
    args.extend(["-p", preset])
    _run_command(args)


def main(argv: List[str] | None = None) -> None:
    if argv is None:
        argv = sys.argv[1:]

    root = Path(os.environ.get("LPM_ROOT", "/"))
    _log(f"Using root: {root}")
    versions = _collect_versions(argv)
    if versions:
        _log(f"Detected kernel versions: {', '.join(versions)}")
    else:
        _log("No kernel versions detected from hook targets")
    preset = os.environ.get("LPM_PRESET", "").strip()
    if preset:
        _log(f"Using mkinitcpio preset: {preset}")

    ran_any = False
    for version in versions:
        _log(f"Processing kernel version: {version}")
        _run_depmod(root, version)
        _run_mkinitcpio(root, version)
        ran_any = True

    if preset:
        _run_preset(root, preset)
        ran_any = True

    if not ran_any:
        _log("No actions to perform; exiting")
        return

    if shutil.which("bootctl"):
        _run_command(["bootctl", "update"], check=False)
    else:
        _log("Skipping systemd-boot update; bootctl not found")

    if shutil.which("grub-mkconfig"):
        _run_command(["grub-mkconfig", "-o", "/boot/grub/grub.cfg"], check=False)
    else:
        _log("Skipping GRUB configuration update; grub-mkconfig not found")


if __name__ == "__main__":
    main()
