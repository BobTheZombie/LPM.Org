#!/usr/bin/env python3
import os
import shutil
import subprocess
import sys
from pathlib import Path
from typing import Iterable, List, Set


def _iter_application_dirs(root: Path, targets: Iterable[str]) -> List[Path]:
    seen: Set[Path] = set()
    dirs: List[Path] = []
    for target in targets:
        rel = str(target).lstrip("/")
        if not rel:
            continue
        path = Path(rel)
        if path.suffix.lower() != ".desktop":
            continue
        candidate = root / path.parent
        if candidate in seen or not candidate.is_dir():
            continue
        seen.add(candidate)
        dirs.append(candidate)
    if dirs:
        return dirs
    default = root / "usr/share/applications"
    if default.is_dir():
        dirs.append(default)
    return dirs


def main(argv: List[str]) -> None:
    tool = shutil.which("update-desktop-database")
    if not tool:
        return
    root = Path(os.environ.get("LPM_ROOT", "/"))
    targets = _iter_application_dirs(root, argv)
    for directory in targets:
        subprocess.run([tool, str(directory)], check=False)


if __name__ == "__main__":
    main(sys.argv[1:])
