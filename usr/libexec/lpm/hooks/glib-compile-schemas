#!/usr/bin/env python3
import os
import shutil
import subprocess
import sys
from pathlib import Path
from typing import Iterable, List, Set


def _iter_schema_dirs(root: Path, targets: Iterable[str]) -> List[Path]:
    seen: Set[Path] = set()
    directories: List[Path] = []
    for target in targets:
        rel = str(target).lstrip("/")
        if not rel:
            continue
        path = root / rel
        if path.suffix.lower() != ".xml":
            continue
        parent = path.parent
        if parent in seen or not parent.is_dir():
            continue
        seen.add(parent)
        directories.append(parent)
    return directories


def main(argv: List[str]) -> None:
    tool = shutil.which("glib-compile-schemas")
    if not tool:
        return
    root = Path(os.environ.get("LPM_ROOT", "/"))
    for directory in _iter_schema_dirs(root, argv):
        subprocess.run(
            [tool, f"--targetdir={directory}", str(directory)],
            check=False,
        )


if __name__ == "__main__":
    main(sys.argv[1:])
